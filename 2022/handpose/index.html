
<!DOCTYPE html>
<html>
  <head>
    <title>JS Playground</title>
    <link rel="stylesheet" href="css/style.css" />
      <script src="https://unpkg.com/ml5@latest/dist/ml5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.min.js"
      integrity="sha512-N4kV7GkNv7QR7RX9YF/olywyIgIwNvfEe2nZtfyj73HdjCUkAfOBDbcuJ/cTaN04JKRnw1YG1wnUyNKMsNgg3g=="
      crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- <script src="./index.js" type="module"></script> -->
  </head>
  <body>
    <!-- <h1>testPlayground</h1> -->
    <!-- <video></video> -->

    <script>
      let newWidth = 0;
      let newHeight = 0;
      let ratio = 1;
      let handpose = null;
      let predictions = [];
      function setup(){
        pixelDensity(1);
        createCanvas(windowWidth, windowHeight);
        noStroke();
        capture = createCapture(VIDEO);
        // P5 met un un petit temps pour charger le stream video
        // createCapture devrait être une promise, pour bloquer la lecture du code
        // mais ça n'est pas le cas, on doit palier à ça en mettant un petit timeout
        setTimeout(()=>{
          console.log(capture.width,capture.height);// 640->480
          // Avec les vraies dimensions de la video on peut faire les calculs de redimensionnement
          // On obtiendra un ratio à appliquer à nos point de posehand, car ils sont calculés sur la video non resizée
          newWidth = windowWidth;
          ratio = newWidth / capture.width;
          newHeight = capture.height * ratio;
        },1000);
        
        // ml5
        handpose = ml5.handpose(capture, modelLoaded.bind(this));
      }

      function draw(){
        image(capture, 0, 0,newWidth,newHeight);
         const prediction = predictions[0];
        //si on a des prediction on met à jour les positions des points
        if (prediction) {
          for (let j = 0; j < prediction.landmarks.length; j += 1) {
            const keypoint = prediction.landmarks[j];
            //on dessine les points, en n'oubliant pas qu'on a aggrandit l'affichage.
            circle(keypoint[0]*ratio,keypoint[1]*ratio,10);
          }
        }
      }

      function modelLoaded(){
        handpose.on("predict", (results) => {
          predictions = results;
        });
      }
    </script>
  </body>
</html>

